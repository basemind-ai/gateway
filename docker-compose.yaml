version: '3.9'

services:
    redis:
        image: redis:latest
        ports:
            - '6379:6379'
    db:
        image: postgres:latest
        volumes:
            - db:/var/lib/postrgresql/data/
        ports:
            - '5432:5432'
        environment:
            POSTGRES_PASSWORD: basemind
            POSTGRES_DB: basemind
            POSTGRES_USER: basemind
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -d $${POSTGRES_DB} -U basemind']
            interval: 30s
            timeout: 5s
            retries: 5
            start_period: 5s
    api-gateway:
        build:
            dockerfile: docker/Dockerfile.go-services
            context: .
            target: install
            args:
                BUILD_TARGET: api-gateway
        ports:
            - '4000:4000'
        volumes:
            - ./.secrets:/go/src/app/.secrets:cached
            - ./gen/go:/go/src/app/gen/go:cached
            - ./services/api-gateway:/go/src/app/services/api-gateway:cached
            - ./shared/go:/go/src/app/shared/go:cached
            - ./go.mod:/go/src/app/go.mod:cached
            - ./go.sum:/go/src/app/go.sum:cached
        environment:
            PORT: 4000
            ENVIRONMENT: development
            BASE_URL: http://localhost:4000
            REDIS_CONNECTION_STRING: redis://redis:6379
            DATABASE_URL: postgresql://basemind:basemind@db:5432/basemind
            GOOGLE_APPLICATION_CREDENTIALS: ./.secrets/firebaseServiceAccountKey.json
            OPENAI_CONNECTOR_ADDRESS: openai-connector:8000
            JWT_SECRET: 'jeronimo'
        command:
            [
                'gow',
                '-e=go,mod,html',
                'run',
                '/go/src/app/services/api-gateway/main.go',
            ]
    dashboard-backend:
        build:
            dockerfile: docker/Dockerfile.go-services
            context: .
            target: install
            args:
                BUILD_TARGET: dashboard-backend
        ports:
            - '4100:4100'
        volumes:
            - ./.secrets:/go/src/app/.secrets:cached
            - ./gen/go:/go/src/app/gen/go:cached
            - ./services/dashboard-backend:/go/src/app/services/dashboard-backend:cached
            - ./shared/go:/go/src/app/shared/go:cached
            - ./go.mod:/go/src/app/go.mod:cached
            - ./go.sum:/go/src/app/go.sum:cached
        environment:
            PORT: 4100
            ENVIRONMENT: development
            REDIS_CONNECTION_STRING: redis://redis:6379
            DATABASE_URL: postgresql://basemind:basemind@db:5432/basemind
            GOOGLE_APPLICATION_CREDENTIALS: ./.secrets/firebaseServiceAccountKey.json
            API_GATEWAY_ADDRESS: api-gateway:4000
            JWT_SECRET: 'jeronimo'
        command:
            [
                'gow',
                '-e=go,mod,html',
                'run',
                '/go/src/app/services/dashboard-backend/main.go',
            ]
    openai-connector:
        build:
            dockerfile: docker/Dockerfile.ts-services
            context: .
            target: install
            args:
                BUILD_TARGET: openai-connector
                PORT: 8000
        ports:
            - '8000:8000'
        volumes:
            - ./gen/ts:/app/gen/ts:cached
            - ./services/openai-connector/src:/app/services/openai-connector/src:cached
            - ./shared/ts/src:/app/shared/ts/src:cached
        environment:
            NODE_ENV: development
            GRPC_VERBOSITY: debug
            GRPC_TRACE: channel,subchannel,call_stream
            PORT: 8000
        working_dir: /app/services/openai-connector
        command: ['pnpm', 'run', 'dev']
        env_file: '.secrets/.env.openai-connector'
    frontend:
        build:
            dockerfile: docker/Dockerfile.frontend
            context: .
            target: install
        ports:
            - '3000:3000'
        volumes:
            - ./shared/ts/src:/app/shared/ts/src:cached
            - ./frontend/public:/app/frontend/public:cached
            - ./frontend/src:/app/frontend/src:cached
        environment:
            NEXT_PUBLIC_BACKEND_BASE_URL: http://localhost:4100
            NODE_ENV: development
        working_dir: /app/frontend
        command: ['pnpm', 'run', 'dev']
        env_file: '.secrets/.env.frontend'
volumes:
    db:
